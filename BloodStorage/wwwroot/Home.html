<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="copyright" content="QA http://www.qa.com">
    <meta name="author" content="Phillip Chan, phillip.chan@qa.com">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/site.css" />

    <title>TODO List Example</title>

</head>


<!---------------------------------------------------------------------------------------
  A onload trigger is added to the body which will call the readTodoItems() function
  which will in turn send a REST API GET request to the microservice to read the todo_list
  from the DB
---------------------------------------------------------------------------------------->
<body onload="readTodoItems()">


    <!---------------------------------------------------------------------------------------
      This is the Header
    ---------------------------------------------------------------------------------------->
    <div class="header">
        <h1>Patient finder</h1>
        <p class="SaveaLife"> Save a life </p>
        <hr />

    </div>

    <br />
    <div>

    </div>
   
    <div>
        
            <form action="javascript:addNewTodoItem()" style="margin-top: 10px">
                <div>
                    <label for="newTodoDescription">Please enter a TODO Item</label>
                    <input type="text" id="newTodoDescription" placeholder="Title..."> <br /> <br />
                </div>
                <div>
                    <label for="newName">Enter your full name</label>
                    <input type="text" id="newName" placeholder="Name..."> <br /> <br />
                </div>

                <div>
                    <label for="newAdress">Please enter your full address</label>
                    <input type="text" id="newAdress" placeholder="Adress..."> <br /> <br />
                </div>

                <div>
                    <label for="age">Please enter your age </label>
                    <input type="text" id="newAge" placeholder="Age..."> <br /> <br />
                </div>

                <div>
                    <label for="newPostcode">Please enter PostCode</label>
                    <input type="text" id="newPostcode" placeholder="Postcode...">
                </div>

                <div>
                    <input type="submit" value="Add" class="addButton" />
                </div>
            </form>
       
    </div>
    



    <hr />
    <br />
    <br />
    <center>
        <div>

            <table>
                <thead>
                    <tr>
                        <th> Patient Name</th>
                        <th>Postcode</th>
                    </tr>
                </thead>
                <tbody id="data-output">
                </tbody>
            </table>
        </div>
    </center>

    <!---------------------------------------------------------------------------------------
      HTML element to hold the todoList.  This is where all the TodoItems will be displayed
    ---------------------------------------------------------------------------------------->
    <div>
        <p>
            <section>
                <ul id="todoList">
                    <!-- This list is empty at start and is populated by the readTodoItems() function
                        called by the onload trigger (see the body element above)
                    -->
                </ul>
            </section>
        </p>
    </div>

    <!---------------------------------------------------------------------------------------
      Scripts
    ---------------------------------------------------------------------------------------->
    <script>
        /****************************************************************************
         * Add a new TodoItem.
         *
         * 1) send an update to the DB
         * 2) if successful then add the item to the list
         ****************************************************************************/
        function addNewTodoItem(newItemValue) {

            // Get the value from the Input field in the FORM
            let nameValue = document.getElementById("newName").value.trim();
            let postcodeValue = document.getElementById("newPostcode").value.trim();
            let ageValue = document.getElementById("newAge").value.trim();
            let adressValue = document.getElementById("newAdress").value.trim();

            // Check that a value have added
            if (nameValue === "") {
                alert("Please enter a value for your item");
            }
            createTodoItem(nameValue, ageValue, postcodeValue, adressValue );
            document.getElementById("newName").value = "";
            document.getElementById("newPostcode").value = "";
            document.getElementById("newAge").value = "";
            document.getElementById("newAdress").value = "";

        }

        /****************************************************************************
         * This function will add the a new todo item to the UL element
         * Specifically this will add:
         *
         *   <li>the item description<span class="close">X</>li>
         *
         * 1) add to DB
         * 2) if successful then add the item to the list
         *
         ****************************************************************************/
        

        /****************************************************************************
         * CRUD functions calling the REST API
         ****************************************************************************/

        function createTodoItem(newName, newAge, newPostCode, newAdress) {

            // Create a new JSON object for the new item with the status of NEW
            // Since the id is generated by the microservice, we will use -1 as a dummy
            // If the POST is successful the microservice will store the new item in the database
            // and returns a JSON via the response with the generated id for the new item
            const newItem = { "name": newName, "age": newAge, "postCode": newPostCode, "address": newAdress};
            const requestOptions = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newItem)
            };
            fetch('https://localhost:7289/api/Patient', requestOptions)
                // get the JSON content from the response
                .then((response) => {
                    if (!response.ok) {
                        alert("An error has occurred.  Unable to create the TODO item")
                        throw response.status;
                    } else return response.json();
                })

                // add the item to the UL element so that it will appear in the browser
                .then(item => addTodoItemToDisplay(item));
        }


        // Load the list - expecting an array of todo_items to be returned
        function readTodoItems() {
            fetch('https://localhost:7289/api/Patient')
                // get the JSON content from the response
                .then((response) => {
                    if (!response.ok) {
                        alert("An error has occurred.  Unable to read the TODO list")
                        throw response.status;
                    } else return response.json();
                })
                // Add the items to the UL element so that it can  be seen
                // As items is an array, we will the array.map function to through the array and add item to the UL element
                // for display
                //.then(items => items.map(item => addTodoItemToDisplay(item)));
                .then(function (patients) {
                    let placeholder = document.querySelector("#data-output");
                    let out = "";

                    for (let patient of patients) {
                        out += `
                                        <tr>
                                          <td>${patient.name} </td>
                                          <td>${patient.postCode} </td>
                                        </tr>
                                      `
                    }
                    placeholder.innerHTML = out;
                })
        }

        function updateTodoItem(item) {
            const requestOptions = {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(item)
            };
            fetch('https://localhost:7289/api/Patient/' + item.nhsId, requestOptions)
                .then((response) => {
                    if (!response.ok) {
                        alert("An error has occurred.  Unable to UPDATE the TODO item")
                        throw response.status;
                    } else return response.json();
                })
        }

        function deleteTodoItem(todoItemId) {
            fetch("https://localhost:7289/api/Patient/" + todoItemId, { method: 'DELETE' }) //Fix
                .then((response) => {
                    if (!response.ok) {
                        alert("An error has occurred.  Unable to DELETE the TODO item")
                        throw response.status;
                    } else return response.json();
                })
        }
    </script>
</body>
</html>